<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">

      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
            <a class="nav-link" href="/profile">Profile</a>
        </li>

        <li class="nav-item active">
            <a class="nav-link" href="http://localhost:4000/posts">Feeds  <span class="sr-only">(current)</span></a>
        </li>

        <li class="nav-item">
            <a class="nav-link" href="/Map">Map</a>
        </li>
        
        <li class="nav-item">
              <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
                  <i class="fa fa-bell noti-icon"></i>
                  <span class="badge badge-danger badge-pill noti-icon-badge"></span>
              </a>
        </li>
        <li class="nav-item">
          <form class="message_notification">
          <a class="nav-link" href="#"><i class="fab fa-facebook-messenger"></i>
            <span class="get_notified_when_message_comes"></span>
          </a>
        </form>
      </li>
        <li class="nav-item">
              <a class="nav-link" href="/logout">Logout</a>
        </li>

      </ul>
      <form class="form-inline" style="margin-right:400px;">
        <input class="form-control mr-sm-2 search" id="search" type="text" placeholder="Search" aria-label="Search" style="width:500px">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit" id="process_search">Search</button>
      </form>
    </div>
  </nav>

  <!-- for search list display-->
  <div class="container" style="z-index:1; position: absolute; width: 535px; margin-left: 505px ">
            <ul class="list-group" id="search_result"></ul>
  </div>

  <!-- for chat(message) display list -->
  <div class="container" style="z-index:1; position: absolute; width: 535px; margin-left: 50px ">
      <br /><br />  
    <ul class="list-group" id="message_list"></ul>
  </div>

                      
  
  <script>
  

$(document).ready(function()
{
    // Get Socket Connection first
    var socket = io.connect();

    setInterval(function()
    {
      update_chat_history_data();
    }, 2000);

    var user_id_from_db = 0; 
      get_user_id();
        

      function get_user_id()
        {
                $.ajax(
                {
                        url:"/posts/user_id",
                        method:"GET",
                        success:function(response)
                        {       
                                if(response !='')
                                {
                                  user_id_from_db = Number(response)
                                        //alert(user_id)
                                        //return response;
                                }
                        },
                        error: function(jqXHR, textStatus, errorThrown)
                                {
                                        console.log('jqXHR:');
                                        console.log(jqXHR);
                                        console.log('textStatus:');
                                        console.log(textStatus);
                                        console.log('errorThrown:');
                                        console.log(errorThrown);
                                        alert(errorThrown);
                        }
                });
        }

        // display all online user list
        function online_user_list()
        {
                $.ajax(
                {
                        url:"/posts/online_user_list",
                        method:"GET",
                        success:function(response)
                        {       
                                if(response !='')
                                {
        var $online_user_list= document.getElementById("online_user_list");
            $online_user_list.innerHTML = "";
                                        
        response.forEach(function(item, index)
            { 
               
                var time = new Date(item.createdAt);
                
                var showtime = time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
                //$chat_history.innerHTML =  $chat_history.innerHTML + `<div class="card" style="margin-bottom:2px; margin-left:80px">  <div class="card-body" style="background:#D5F5E3;height:60px">You..</div></div></div>`;
                $online_user_list.innerHTML =  
$online_user_list.innerHTML + 
`<div class="d-flex bd-highlight online_user" data-online_user_profile_pic="${item.user_profile_pic}" data-online_user_firstname="${item.user_firstname}" data-online_user_id="${item.user_id}"><div class="img_cont"><img src="../public/profile_image/${item.user_profile_pic}" class="rounded-circle user_img"><span class="online_icon"></span> </div><div class="user_info"><span>${item.user_firstname}</span><p>${showtime}</p></div> </div>`;
                alert(showtime);
            })
                                }
                                else{
                                        alert("data null");
                                }
                        },
                        error: function(jqXHR, textStatus, errorThrown)
                                {
                                        console.log('jqXHR:');
                                        console.log(jqXHR);
                                        console.log('textStatus:');
                                        console.log(textStatus);
                                        console.log('errorThrown:');
                                        console.log(errorThrown);
                                        alert(errorThrown);
                        }
                });
        }
        online_user_list();

        $(document).on('click','.online_user',function()
        {
                var to_user_id = $(this).data('online_user_id');
                var to_user_name = $(this).data('online_user_firstname');
                var user_profile_pic = $(this).data('online_user_profile_pic');
                make_chat_dialog_box(to_user_id, to_user_name,user_profile_pic);
      $("#user_dialog_"+to_user_id).dialog(
      {
        autoOpen:false,
        width:350,
        minHeight: 'auto',
        dialogClass: "MyClass"
        
        
        //fontsize:1em
        
      });
      $('#user_dialog_'+to_user_id).dialog('open').prev().css({"color": "white",
      "background-color": "#343a40",
      "font-family": "sans-serif"
    });
                
        })

    // Dialog Box
    function make_chat_dialog_box(to_user_id, to_user_name,user_profile_pic)
    {
      //var modal_content = '<div><img src="'+user_profile_pic+' height="40" width="40" class="img-thumbnail" /></div>';
    var modal_content = '<div id="user_dialog_'+to_user_id+'"  class="user_dialog roundbox boxshadow"  title="'+to_user_name+'">';
    modal_content += '<div style="background-color:#F5F5F5;height:300px; overflow-y: scroll; margin-bottom:20px;" class="chat_history" data-touserid="'+to_user_id+'" id="chat_history_'+to_user_id+'">';
    modal_content += get_user_chat_history(to_user_id);
    modal_content += '</div>';
    modal_content += '<div class="row">';
    modal_content += '<div class="col-8"> <input type="tex" name="chat_message_'+to_user_id+'" id="chat_message_'+to_user_id+'" class="form-control"/></div>';
    modal_content += '<div class="col">';
    modal_content+= '<button type="button" name="send_chat" id="'+to_user_id+'" class="btn btn-info rounded mycustombtn send_chat">Send</button></div></div></div></div>';
    $('#user_model_details').html(modal_content);
    }

    // Dilog Box appear after clicking the user list 
    $(document).on('click', '.message_click', function()
    {

      var to_user_id =$(this).data('userid'); // get user_id to whom you want to send request
      var to_user_name = $(this).data('username') // status ..what you want to do follow or unfollow /follow,requested/following(accept)
      var user_profile_pic = $(this).data('user_profile_pic');
      //alert(user_profile_pic);
      var $message_list = $('#message_list');
      $message_list.slideToggle('slow');
      make_chat_dialog_box(to_user_id, to_user_name,user_profile_pic);
      $("#user_dialog_"+to_user_id).dialog(
      {
        autoOpen:false,
        width:350,
        minHeight: 'auto',
        dialogClass: "MyClass"
        
        
        //fontsize:1em
        
      });
      $('#user_dialog_'+to_user_id).dialog('open').prev().css({"color": "white",
      "background-color": "#343a40",
      "font-family": "sans-serif"
    });

      // $.ajax(
      //   {
      //     url:"/posts/get_single_user",
      //     method:"POST",
      //     data:{to_user_id:to_user_id},
      //     success:function(response)
      //     {
      //       make_chat_dialog_box(to_user_id, to_user_name);
           
      //     }
      //   })

     
   
    });

// insert data into chat box
$(document).on('click', '.send_chat', function()
    {
        var to_user_id = $(this).attr('id');
        var chat_message = $('#chat_message_'+to_user_id).val();
        //alert(chat_message);
        $.ajax(
        {
          url:"/posts/get_chat_message",
          method:"POST",
          data:{to_user_id:to_user_id, chat_message:chat_message},
          success:function(response)
          {

            $('#chat_message_'+to_user_id).val('');// clear chat box
            var $chat_history= document.getElementById("chat_history_"+to_user_id);
            $chat_history.innerHTML = "";
            response.forEach(function(item, index)
            { 
            var time = new Date(item.createdAt);
             var showtime = time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
             //$chat_history.innerHTML =  $chat_history.innerHTML + `<div class="card" style="margin-bottom:2px">  <div class="card-body" style="background:#D5F5E3;height:60px"><small>${item.message_content}</small><div align="right">- <small><em>${showtime}</em></small></div></div></div>`;
             // $('#chat_history_'+to_user_id).append('<div class="card" style="margin-bottom:2px">  <div class="card-body" style="background:#D5F5E3;height:60px"><small>' +item.message_content+ '</small><div align="right">- <small><em>'+showtime+'</em></small></div></div></div>');         
             if(user_id_from_db == item.user_id) // if you
              {
                //$chat_history.innerHTML =  $chat_history.innerHTML + `<div class="card" style="margin-bottom:2px; margin-left:80px">  <div class="card-body" style="background:#D5F5E3;height:60px">You..</div></div></div>`;
                $chat_history.innerHTML =  $chat_history.innerHTML + `<div class="card" style="margin-bottom:2px;margin-left:80px">  <div class="card-body" style="background:#D5F5E3;height:60px"><small>${item.message_content}</small><div align="right">- <small><em>${showtime}</em></small></div></div></div>`;
              }
              else{ // else other
                $chat_history.innerHTML =  $chat_history.innerHTML + `<div class="card" style="margin-bottom:2px;margin-right:80px">  <div class="card-body" style="background:#FBEEE6;height:60px"><small>${item.message_content}</small><div align="right">- <small><em>${showtime}</em></small></div></div></div>`;
               // $chat_history.innerHTML =  $chat_history.innerHTML + `<div class="card" style="margin-bottom:2px; margin-right:80px">  <div class="card-body" style="background:#FBEEE6;height:60px">others..</div></div></div>`;
              }
            })

          }
        })
    });

    // get chat history to display
  function get_user_chat_history(to_user_id)
  {
    $.ajax({
      url: "/posts/get_user_chat_history",
      method: "POST",
      data: {to_user_id:to_user_id},
      success:function(response)
      {

        var $chat_history= document.getElementById("chat_history_"+to_user_id);
        $chat_history.innerHTML = "";
        response.forEach(function(item, index)
            { 
              
             var time = new Date(item.createdAt);
             var showtime = time.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }) 
        
              if(user_id_from_db == item.user_id) // if you
              {
        
                $chat_history.innerHTML =  $chat_history.innerHTML + `<div class="card-body" style="margin:10px;margin-left:80px; background:#D5F5E3;height:60px;border-radius: 5px 20px 0px 15px;"><small>${item.message_content}</small><div align="right"><small><em>${showtime}</em></small></div></div>`;
              }
              else{ // else other
                $chat_history.innerHTML =  $chat_history.innerHTML + `<div class="card-body" style="margin:10px;margin-right:80px; background:#FBEEE6;height:60px;border-radius: 5px 5px 10px 0px;"><small>${item.message_content}</small><div align="right"><small><em>${showtime}</em></small></div></div>`;
              
              }
          })

        
      },

    })
  }



  function count_unseen_message()
  {
    var $get_notified_when_message_comes = $('.get_notified_when_message_comes');
    $.ajax({
      url: "/posts/count_unseen_message",
      method: "GET",
     // data: {user_id_from_db:user_id_from_db},
      success:function(response)
      {
        //alert(response.length)
        $get_notified_when_message_comes.append('<small>'+response.length+'</small>')
        //var $get_notified_when_message_comes = $('.get_notified_when_message_comes');
        //alert(response.count);
        // response.forEach(function(item, index)
        // { `</small style=""><small><em>10</em></small>`
        //   alert(item.count);
            
        // })

        
      },

    }) 
  }
  
  count_unseen_message();
  
  function update_chat_history_data()
  {

      $('.chat_history').each(function()
      {
        var to_user_id = $(this).data('touserid');
        get_user_chat_history(to_user_id);
      });
  } 

$(document).on('click', '.ui-button-icon', function()
{
 $('.user_dialog').dialog('destroy').remove();
});



$(document).on('click','.message_notification',function()
    {
      //alert("clicked works..");
      var $message_notification = $('.message_notification');
      //var $message_list = $('#message_list');

      $.ajax(
        {
          url:"/posts/findUser",
          method:"GET",
          success:function(response)
          {
              //$message_list.val('');
              var $message_list= document.getElementById("message_list");
              $message_list.innerHTML = '';
              $.each(response, function(key, value)
              {
               
                  $message_list.innerHTML =  $message_list.innerHTML + `<div class="card message_click" data-user_profile_pic ="${value.user_profile_pic}" data-username="${value.user_firstname+ ' ' +value.user_lastname}" data-userid="${value.user_id}"><li class="list-group-item link-class"><img src="../public/profile_image/${value.user_profile_pic}" height="40" width="40" class="img-thumbnail" /> ${value.user_firstname+ ' ' +value.user_lastname}</li></div>`;
                  //$message_list.append('<div class="card message_click" data-username="'+value.user_firstname+ ' ' +value.user_lastname+'" data-userid="'+value.user_id+'"><li class="list-group-item link-class"><img src="'+value.user_profile_pic+'" height="40" width="40" class="img-thumbnail" /> '+value.user_firstname+ ' ' +value.user_lastname+'</li></div>');
                  
              });
              
              $('#message_list').slideToggle('slow');
              
                  
                

          },
          error:function(jqXHR, textStatus, errorThrown)
          {
            console.log('jqXHR:');
            console.log(jqXHR);
            console.log('textStatus:');
            console.log(textStatus);
            console.log('errorThrown:');
            console.log(errorThrown);
            alert(errorThrown);
          }

        })
    });

// Implementing User Search Option(API)
$(document).ready(function()
    {
      $('#search').keyup(function()
      {
        //alert("inside search")
        $('#search_result').html('');
        var search_Field = $('#search').val();
        //alert(search_Field)
        var expression = new RegExp(search_Field,"i");
        //alert(expression)
        $.ajax(
        {
          url:"/posts/findUser",
          method:"GET",
          //data:{expression:expression},
          success:function(response)
          {
            //alert(response)
            var $search_result= document.getElementById("search_result");
              $search_result.innerHTML = '';
              $.each(response, function(key, value)
              {
               //alert(value.user_firstname)
                if (value.user_firstname.search(expression) != -1 || value.user_email.search(expression) != -1)
                {
                  $search_result.innerHTML =  $search_result.innerHTML + `<div class="card" ${value.user_id}><li class="list-group-item link-class"><img src="../public/profile_image/${value.user_profile_pic}" height="40" width="40" class="img-thumbnail" /> ${value.user_firstname+ ' ' +value.user_lastname}</li></div>`;
                  //$('#search_result').append('<div class="card" '+value.user_id+'><li class="list-group-item link-class"><img src="'+value.user_profile_pic+'" height="40" width="40" class="img-thumbnail" /> '+value.user_firstname+ ' ' +value.user_lastname+'</li></div>');
                }
              });
              
              $('#search_result').on('click', 'li', function() 
              {
                  var click_text = $(this).text().split('|');
                  $('#search').val($.trim(click_text[0]));
                  $("#result").html('');
              });
              $('#process_search').on('click',function()
              {
                //alert("in process search")
                var get_content = document.getElementById('search').value
               // var trimStr = $.trim(myStr);
                var content = $.trim(get_content)
                //alert(content)
                $.ajax({
                  url:"/posts/processSearch",
                  method:"POST", 
                  data:{get_content:content},
                  success:function(response)
                  {
                    //alert(response.user_id)
                    window.location.assign('viewprofile/'+response.user_id);
                  },
                  error:function(jqXHR, textStatus, errorThrown)
                  {
                    console.log('jqXHR:');
                    console.log(jqXHR);
                    console.log('textStatus:');
                    console.log(textStatus);
                    console.log('errorThrown:');
                    console.log(errorThrown);
                    alert(errorThrown);
                  }
                })
              })

          },
          error:function(jqXHR, textStatus, errorThrown)
          {
            console.log('jqXHR:');
            console.log(jqXHR);
            console.log('textStatus:');
            console.log(textStatus);
            console.log('errorThrown:');
            console.log(errorThrown);
            alert(errorThrown);
          }

        })
        
      });
    });

  });

  </script>